<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.21/vue.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/superagent/1.2.0/superagent.js" charset="utf-8"></script>
    <style media="screen">
      li.status-0 {
        background-color: #3CA39C;
      }
      li.status-1 {
        background-color: #FF827D;
      }
      li.status-2 {
        background-color: #E0DCBB;
      }
      .staggered-transition {
        transition: all 0.5s ease;
        margin: 0;
        height: 20px;
      }
      .staggered-enter,
      .staggered-leave {
        opacity: 0;
        height: 0;
      }

    </style>
    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', init);
      function init() {
        var TaskList = Vue.extend({
          props: ["project"],
          template: `
            <div v-if="project">
              <h1>{{project.name}}のタスク一覧</h1>
              <div v-if="!selectedTask">
                <input type="text" v-model="description" @keyup.enter="addTask"></input>
                <button @click="addTask">Add Task</button>
              </div>
              <div v-else>
                <input type="text" v-model="description" @keyup.enter="modifyTask"></input>
                <button @click="modifyTask">Modify Task</button>
              </div>
              <ul class="task-list">
                <li class="status-{{item.status}}" v-for="item in tasks| limitBy limit position" @click="select(item)" @mousewheel="scroll" transition="staggered" stagger="20">
                  {{ item.description }}
                </li>
              </ul>
          `,
          data: function () {
            return {tasks: [],selectedTask:null,position:0,limit:5};
          },
          init: function () {},
          ready: function () {
            if (this.project != null)
              this.call()
            this.$watch("project", this.call);
          },
          methods: {
            call: function () {
              this.selectedTask=null
              superagent.get("/task/" + this.project.id).set('Accept', 'application/json').end(
                (err, res) => {
                  this.tasks = JSON.parse(res.text).reverse();
                  this.position=(this.tasks.length+this.position)%this.tasks.length||0;

                }
              );
            },
            addTask:function(){
              superagent.post("/task").send({project:this.project.id, description:this.description})
                .set('Accept', 'application/json').end((err, res) => this.call());
              this.description=""
            },
            modifyTask:function(){
              this.selectedTask.description=this.description
              this.description=""
              superagent.put("/task").send(this.selectedTask)
              .set('Accept', 'application/json')
              .end((err, res) => this.call());
            },
            select:function(task){
              this.selectedTask=task;
              this.description=task.description
            },
            scroll:function(e){
              e.preventDefault();
              var diff=e.deltaY>0?1:-1;
              this.position=(this.tasks.length+this.position+diff)%this.tasks.length||0;
            }
          }
        })
        Vue.component('task-list', TaskList);
        var ProjectList = Vue.extend({
          template: `
              <ul class="project-list">
                <li class="" v-for="project in projects"  v-on:click="select(project)">
                  {{ project.name }}
                </li>
              </ul>
              <input type="text" v-model="newName"></input>
              <button @click="newProject">New Project</button>
              <task-list :project="selectedProject"></task-list>
            `,
          data: function () {
            return {selectedProject: null, projects: [],newName:""};
          },
          init: function () {
            superagent.get("/project").set('Accept', 'application/json').end((err, res) => {
              this.projects = JSON.parse(res.text);
              this.selectedProject = this.projects[0]
            });
          },
          methods: {
            select: function (project) {
              this.selectedProject = project
            },

            newProject: function(){
              superagent.post("/project").send({name:this.newName}).set('Accept','application/json').end((err,res)=>{
                if(err)return;
                var project=JSON.parse(res.text);
                this.projects.push(project);
                this.selectedProject=project;
              });
            }
          }
        })
        Vue.component('project-list', ProjectList);
        var App = new Vue({el: "#app"});
        console.log("test");
      }
    </script>
  </head>
  <body id="app">
    <h1>プロジェクト一覧</h1>
    <project-list></project-list>
  </body>
</html>
